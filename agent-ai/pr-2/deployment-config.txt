# Docker Compose Configuration
# docker-compose.yml

version: '3.8'

services:
  # ä¸»Agentç³»ç»ŸæœåŠ¡
  agent-system:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: local-agent-system
    environment:
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - QWEN_API_KEY=${QWEN_API_KEY}
      - WORKSPACE_DIR=/app/workspace
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    volumes:
      - ./workspace:/app/workspace
      - ./logs:/app/logs
      - /tmp/.X11-unix:/tmp/.X11-unix:rw  # For GUI apps
    ports:
      - "8000:8000"  # APIç«¯å£
      - "8501:8501"  # Streamlit UIç«¯å£
    networks:
      - agent-network
    depends_on:
      - redis
      - postgres
    restart: unless-stopped
    # å¯¹äºæµè§ˆå™¨è‡ªåŠ¨åŒ–ï¼Œéœ€è¦ç‰¹æ®Šæƒé™
    privileged: true
    shm_size: '2gb'
    
  # Redisç”¨äºä»»åŠ¡é˜Ÿåˆ—å’Œç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: agent-redis
    volumes:
      - redis-data:/data
    networks:
      - agent-network
    restart: unless-stopped
    
  # PostgreSQLç”¨äºæŒä¹…åŒ–å­˜å‚¨
  postgres:
    image: postgres:15-alpine
    container_name: agent-postgres
    environment:
      - POSTGRES_USER=agent
      - POSTGRES_PASSWORD=agent_pass
      - POSTGRES_DB=agent_system
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - agent-network
    restart: unless-stopped
    
  # æœ¬åœ°DeepSeek-CoderæœåŠ¡ï¼ˆä½¿ç”¨Ollamaï¼‰
  deepseek-local:
    image: ollama/ollama:latest
    container_name: deepseek-local
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - "11434:11434"
    networks:
      - agent-network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
              
networks:
  agent-network:
    driver: bridge
    
volumes:
  redis-data:
  postgres-data:
  ollama-data:

---
# Dockerfile

FROM python:3.11-slim

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    # åŸºç¡€å·¥å…·
    curl \
    wget \
    git \
    vim \
    # æµè§ˆå™¨è‡ªåŠ¨åŒ–ä¾èµ–
    chromium \
    chromium-driver \
    # GUIè‡ªåŠ¨åŒ–ä¾èµ–
    python3-tk \
    python3-dev \
    xvfb \
    x11vnc \
    fluxbox \
    # OCRä¾èµ–
    tesseract-ocr \
    tesseract-ocr-chi-sim \
    tesseract-ocr-eng \
    # å›¾åƒå¤„ç†
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    # æ¸…ç†
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/workspace /app/logs /app/data

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DISPLAY=:99
ENV PYTHONPATH=/app

# å¯åŠ¨è„šæœ¬
COPY docker-entrypoint.sh /
RUN chmod +x /docker-entrypoint.sh

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["python", "main.py"]

---
# requirements.txt

# æ ¸å¿ƒä¾èµ–
aiohttp==3.9.1
asyncio==3.4.3
pydantic==2.5.0
python-dotenv==1.0.0

# LLMç›¸å…³
anthropic==0.25.0
openai==1.40.0
langchain==0.1.0
langchain-community==0.0.10
langgraph==0.0.26

# æµè§ˆå™¨è‡ªåŠ¨åŒ–
playwright==1.40.0
selenium==4.15.0
beautifulsoup4==4.12.2

# ç³»ç»Ÿè‡ªåŠ¨åŒ–
pyautogui==0.9.54
keyboard==0.13.5
mouse==0.7.1
mss==9.0.1
Pillow==10.1.0

# å›¾åƒå¤„ç†å’ŒOCR
opencv-python==4.8.1.78
pytesseract==0.3.10
numpy==1.24.3

# æ•°æ®åº“
redis==5.0.1
psycopg2-binary==2.9.9
sqlalchemy==2.0.23
alembic==1.12.1

# Webæ¡†æ¶
fastapi==0.104.1
uvicorn==0.24.0
streamlit==1.28.2
gradio==4.7.1

# å·¥å…·
pyyaml==6.0.1
click==8.1.7
rich==13.7.0
loguru==0.7.2

# ç›‘æ§
prometheus-client==0.19.0
psutil==5.9.6

# æµ‹è¯•
pytest==7.4.3
pytest-asyncio==0.21.1
pytest-cov==4.1.0

# Windowsç‰¹å®šä¾èµ–ï¼ˆå¯é€‰ï¼‰
# pywin32==306  # Windows only

---
# docker-entrypoint.sh

#!/bin/bash

# å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºå™¨ï¼ˆç”¨äºæ— å¤´ç¯å¢ƒçš„GUIæ“ä½œï¼‰
if [ "$DISPLAY" = ":99" ]; then
    Xvfb :99 -screen 0 1920x1080x24 &
    sleep 2
    fluxbox &
    x11vnc -display :99 -nopw -listen localhost -xkb -forever &
fi

# ç­‰å¾…æ•°æ®åº“å°±ç»ª
echo "Waiting for PostgreSQL..."
while ! nc -z postgres 5432; do
    sleep 1
done
echo "PostgreSQL is ready!"

echo "Waiting for Redis..."
while ! nc -z redis 6379; do
    sleep 1
done
echo "Redis is ready!"

# è¿è¡Œæ•°æ®åº“è¿ç§»
alembic upgrade head

# ä¸‹è½½DeepSeek-Coderæ¨¡å‹åˆ°æœ¬åœ°Ollamaï¼ˆå¦‚æœé…ç½®äº†ï¼‰
if [ "$USE_LOCAL_DEEPSEEK" = "true" ]; then
    echo "Pulling DeepSeek-Coder model..."
    curl -X POST http://deepseek-local:11434/api/pull -d '{"name": "deepseek-coder:6.7b"}'
fi

# å®‰è£…Playwrightæµè§ˆå™¨
playwright install chromium

# å¯åŠ¨åº”ç”¨
exec "$@"

---
# .env.example

# API Keys
CLAUDE_API_KEY=your_claude_api_key_here
DEEPSEEK_API_KEY=your_deepseek_api_key_here  # å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨æœ¬åœ°æ¨¡å‹
QWEN_API_KEY=your_qwen_api_key_here

# Model Configuration
CLAUDE_MODEL=claude-opus-4-20250514
DEEPSEEK_MODEL=deepseek-coder
QWEN_MODEL=qwen-plus

# System Configuration
WORKSPACE_DIR=./workspace
LOG_LEVEL=INFO
USE_LOCAL_DEEPSEEK=true

# Database Configuration
POSTGRES_USER=agent
POSTGRES_PASSWORD=agent_pass
POSTGRES_DB=agent_system
POSTGRES_HOST=postgres
POSTGRES_PORT=5432

REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0

# Cost Limits (in USD)
MAX_COST_PER_REQUEST=2.0
MAX_DAILY_COST=100.0

# Performance Settings
MAX_AGENTS=10
MAX_CONCURRENT_TASKS=5
TASK_TIMEOUT=300  # seconds

# Security
ENABLE_SANDBOX=true
ALLOWED_COMMANDS=ls,pwd,echo,cat,grep,find
BLOCKED_PATHS=/etc,/sys,/proc

---
# Kubernetesé…ç½® (k8s-deployment.yaml)

apiVersion: v1
kind: Namespace
metadata:
  name: agent-system

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: agent-config
  namespace: agent-system
data:
  LOG_LEVEL: "INFO"
  WORKSPACE_DIR: "/app/workspace"
  USE_LOCAL_DEEPSEEK: "true"
  
---
apiVersion: v1
kind: Secret
metadata:
  name: agent-secrets
  namespace: agent-system
type: Opaque
stringData:
  CLAUDE_API_KEY: "your_claude_api_key"
  DEEPSEEK_API_KEY: "your_deepseek_api_key"
  QWEN_API_KEY: "your_qwen_api_key"
  
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: agent-system
  namespace: agent-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: agent-system
  template:
    metadata:
      labels:
        app: agent-system
    spec:
      containers:
      - name: agent-system
        image: local-agent-system:latest
        ports:
        - containerPort: 8000
          name: api
        - containerPort: 8501
          name: ui
        envFrom:
        - configMapRef:
            name: agent-config
        - secretRef:
            name: agent-secrets
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "8Gi"
            cpu: "4000m"
        volumeMounts:
        - name: workspace
          mountPath: /app/workspace
        - name: logs
          mountPath: /app/logs
      volumes:
      - name: workspace
        persistentVolumeClaim:
          claimName: workspace-pvc
      - name: logs
        persistentVolumeClaim:
          claimName: logs-pvc
          
---
apiVersion: v1
kind: Service
metadata:
  name: agent-system-service
  namespace: agent-system
spec:
  selector:
    app: agent-system
  ports:
  - name: api
    port: 8000
    targetPort: 8000
  - name: ui
    port: 8501
    targetPort: 8501
  type: LoadBalancer

---
# éƒ¨ç½²è„šæœ¬ (deploy.sh)

#!/bin/bash

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}ğŸš€ Local Agent System Deployment Script${NC}"

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    echo -e "${YELLOW}Checking dependencies...${NC}"
    
    dependencies=("docker" "docker-compose" "git")
    for dep in "${dependencies[@]}"; do
        if ! command -v $dep &> /dev/null; then
            echo -e "${RED}âŒ $dep is not installed${NC}"
            exit 1
        else
            echo -e "${GREEN}âœ… $dep is installed${NC}"
        fi
    done
}

# é…ç½®ç¯å¢ƒ
setup_environment() {
    echo -e "${YELLOW}Setting up environment...${NC}"
    
    if [ ! -f .env ]; then
        cp .env.example .env
        echo -e "${YELLOW}âš ï¸  Please edit .env file with your API keys${NC}"
        exit 1
    fi
    
    # åˆ›å»ºå¿…è¦çš„ç›®å½•
    mkdir -p workspace logs data
}

# æ„å»ºé•œåƒ
build_images() {
    echo -e "${YELLOW}Building Docker images...${NC}"
    docker-compose build
}

# å¯åŠ¨æœåŠ¡
start_services() {
    echo -e "${YELLOW}Starting services...${NC}"
    docker-compose up -d
    
    # ç­‰å¾…æœåŠ¡å°±ç»ª
    echo -e "${YELLOW}Waiting for services to be ready...${NC}"
    sleep 10
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    docker-compose ps
}

# ä¸»å‡½æ•°
main() {
    check_dependencies
    setup_environment
    build_images
    start_services
    
    echo -e "${GREEN}âœ… Deployment completed!${NC}"
    echo -e "${GREEN}Access the system at:${NC}"
    echo -e "  - API: http://localhost:8000"
    echo -e "  - UI: http://localhost:8501"
    echo -e "  - Docs: http://localhost:8000/docs"
}

# è¿è¡Œä¸»å‡½æ•°
main

---
# æ€§èƒ½ä¼˜åŒ–é…ç½® (performance.yaml)

performance:
  # æ¨¡å‹é€‰æ‹©ç­–ç•¥
  model_selection:
    simple_tasks:
      primary: deepseek-local  # æœ¬åœ°æ¨¡å‹ï¼Œæ— æˆæœ¬
      fallback: qwen  # APIæˆæœ¬ä½
    complex_tasks:
      primary: claude  # æœ€å¼ºèƒ½åŠ›
      fallback: qwen  # æˆæœ¬å¹³è¡¡
      
  # ç¼“å­˜ç­–ç•¥
  caching:
    enable: true
    ttl: 3600  # 1å°æ—¶
    max_size: 1000  # æœ€å¤§ç¼“å­˜æ¡ç›®
    
  # å¹¶å‘æ§åˆ¶
  concurrency:
    max_agents: 5
    max_tasks_per_agent: 3
    queue_size: 100
    
  # æˆæœ¬æ§åˆ¶
  cost_control:
    max_cost_per_task: 0.5
    max_cost_per_hour: 10.0
    alert_threshold: 0.8  # 80%æ—¶å‘Šè­¦
    
  # èµ„æºé™åˆ¶
  resource_limits:
    max_memory_per_agent: "1Gi"
    max_cpu_per_agent: "1000m"
    task_timeout: 300  # 5åˆ†é’Ÿ
    
  # æ‰¹å¤„ç†ä¼˜åŒ–
  batching:
    enable: true
    batch_size: 10
    batch_timeout: 5  # ç§’
